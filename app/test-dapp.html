<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DApp Bridge Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">DApp Bridge 测试页面</h1>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">SAT20 Provider 状态</h2>
            <div id="provider-status" class="space-y-2">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-2" id="status-indicator"></div>
                    <span id="status-text">检查中...</span>
                </div>
                <div id="provider-info" class="text-sm text-gray-600 mt-2"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">可用方法</h2>
            <div id="methods-list" class="grid grid-cols-2 gap-2 text-sm"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">测试功能</h2>
            <div class="space-y-4">
                <div>
                    <button onclick="testGetAccounts()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">
                        获取账户 (getAccounts)
                    </button>
                    <button onclick="testGetNetwork()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                        获取网络 (getNetwork)
                    </button>
                    <button onclick="testGetBalance()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        获取余额 (getBalance)
                    </button>
                </div>

                <div>
                    <button onclick="testRequestAccounts()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 mr-2">
                        请求账户权限 (requestAccounts)
                    </button>
                    <button onclick="testSignMessage()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        签名消息 (signMessage)
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">测试结果</h2>
            <div id="test-results" class="bg-gray-50 p-4 rounded text-sm font-mono min-h-[200px]"></div>
        </div>
    </div>

    <script>
        // 检查 SAT20 Provider 是否可用
        function checkProvider() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const providerInfo = document.getElementById('provider-info');
            const methodsList = document.getElementById('methods-list');

            if (window.sat20) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                statusText.textContent = 'SAT20 Provider 已连接';

                const methods = Object.keys(window.sat20).filter(key => typeof window.sat20[key] === 'function');
                providerInfo.innerHTML = `找到 ${methods.length} 个可用方法`;

                methodsList.innerHTML = methods.map(method =>
                    `<div class="bg-gray-100 p-2 rounded">${method}()</div>`
                ).join('');

                log('✅ SAT20 Provider 检测成功，可用方法：' + methods.join(', '));

                // 通知父窗口 provider 状态
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'SAT20_STATUS_UPDATE',
                            status: 'connected',
                            methods: methods
                        }, '*');
                    }
                } catch (e) {
                    // 忽略跨域错误
                }
            } else {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'SAT20 Provider 未找到';
                providerInfo.innerHTML = '请确保在 SAT20 钱包的 DApp 浏览器中打开此页面';
                methodsList.innerHTML = '';

                log('❌ SAT20 Provider 未检测到');

                // 通知父窗口 provider 状态
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'SAT20_STATUS_UPDATE',
                            status: 'disconnected'
                        }, '*');
                    }
                } catch (e) {
                    // 忽略跨域错误
                }
            }
        }

        function log(message) {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        async function testGetAccounts() {
            try {
                log('🔍 调用 getAccounts()...');
                const accounts = await window.sat20.getAccounts();
                log('✅ getAccounts 成功: ' + JSON.stringify(accounts));
            } catch (error) {
                log('❌ getAccounts 失败: ' + error.message);
            }
        }

        async function testGetNetwork() {
            try {
                log('🔍 调用 getNetwork()...');
                const network = await window.sat20.getNetwork();
                log('✅ getNetwork 成功: ' + JSON.stringify(network));
            } catch (error) {
                log('❌ getNetwork 失败: ' + error.message);
            }
        }

        async function testGetBalance() {
            try {
                log('🔍 调用 getBalance()...');
                const balance = await window.sat20.getBalance();
                log('✅ getBalance 成功: ' + JSON.stringify(balance));
            } catch (error) {
                log('❌ getBalance 失败: ' + error.message);
            }
        }

        async function testRequestAccounts() {
            try {
                log('🔍 调用 requestAccounts()...');
                const accounts = await window.sat20.requestAccounts();
                log('✅ requestAccounts 成功: ' + JSON.stringify(accounts));
            } catch (error) {
                log('❌ requestAccounts 失败: ' + error.message);
            }
        }

        async function testSignMessage() {
            try {
                log('🔍 调用 signMessage()...');
                const message = 'Hello SAT20 Wallet!';
                const signature = await window.sat20.signMessage(message);
                log('✅ signMessage 成功: ' + JSON.stringify(signature));
            } catch (error) {
                log('❌ signMessage 失败: ' + error.message);
            }
        }

        // 监听来自父窗口的消息
        window.addEventListener('message', function(event) {
            // 处理检查请求
            if (event.data.type === 'SAT20_CHECK_REQUEST' && event.data.source === 'parent') {
                window.parent.postMessage({
                    type: 'SAT20_CHECK_RESPONSE',
                    messageId: event.data.messageId,
                    hasSat20: !!window.sat20,
                    methods: window.sat20 ? Object.keys(window.sat20) : []
                }, '*');
                return;
            }

            // 处理测试请求
            if (event.data.type === 'SAT20_TEST_REQUEST' && event.data.source === 'parent') {
                const satProperties = Object.getOwnPropertyNames(window).filter(name => name.toLowerCase().includes('sat'));
                window.parent.postMessage({
                    type: 'SAT20_TEST_RESPONSE',
                    messageId: event.data.messageId,
                    hasSat20: !!window.sat20,
                    methods: window.sat20 ? Object.keys(window.sat20) : [],
                    hasGetAccounts: window.sat20 && typeof window.sat20.getAccounts === 'function',
                    satProperties: satProperties
                }, '*');
                return;
            }
        });

        // 页面加载时检查 provider
        document.addEventListener('DOMContentLoaded', function() {
            checkProvider();

            // 每隔几秒重新检查，以防 provider 稍后注入
            setInterval(checkProvider, 3000);
        });
    </script>
</body>
</html>