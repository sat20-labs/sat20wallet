<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DApp Bridge Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">DApp Bridge æµ‹è¯•é¡µé¢</h1>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">SAT20 Provider çŠ¶æ€</h2>
            <div id="provider-status" class="space-y-2">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-2" id="status-indicator"></div>
                    <span id="status-text">æ£€æŸ¥ä¸­...</span>
                </div>
                <div id="provider-info" class="text-sm text-gray-600 mt-2"></div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">å¯ç”¨æ–¹æ³•</h2>
            <div id="methods-list" class="grid grid-cols-2 gap-2 text-sm"></div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•åŠŸèƒ½</h2>
            <div class="space-y-4">
                <div>
                    <button onclick="testGetAccounts()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mr-2">
                        è·å–è´¦æˆ· (getAccounts)
                    </button>
                    <button onclick="testGetNetwork()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 mr-2">
                        è·å–ç½‘ç»œ (getNetwork)
                    </button>
                    <button onclick="testGetBalance()" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                        è·å–ä½™é¢ (getBalance)
                    </button>
                </div>

                <div>
                    <button onclick="testRequestAccounts()" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 mr-2">
                        è¯·æ±‚è´¦æˆ·æƒé™ (requestAccounts)
                    </button>
                    <button onclick="testSignMessage()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                        ç­¾åæ¶ˆæ¯ (signMessage)
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6 mt-6">
            <h2 class="text-xl font-semibold mb-4">æµ‹è¯•ç»“æœ</h2>
            <div id="test-results" class="bg-gray-50 p-4 rounded text-sm font-mono min-h-[200px]"></div>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ SAT20 Provider æ˜¯å¦å¯ç”¨
        function checkProvider() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const providerInfo = document.getElementById('provider-info');
            const methodsList = document.getElementById('methods-list');

            if (window.sat20) {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-500 mr-2';
                statusText.textContent = 'SAT20 Provider å·²è¿æ¥';

                const methods = Object.keys(window.sat20).filter(key => typeof window.sat20[key] === 'function');
                providerInfo.innerHTML = `æ‰¾åˆ° ${methods.length} ä¸ªå¯ç”¨æ–¹æ³•`;

                methodsList.innerHTML = methods.map(method =>
                    `<div class="bg-gray-100 p-2 rounded">${method}()</div>`
                ).join('');

                log('âœ… SAT20 Provider æ£€æµ‹æˆåŠŸï¼Œå¯ç”¨æ–¹æ³•ï¼š' + methods.join(', '));

                // é€šçŸ¥çˆ¶çª—å£ provider çŠ¶æ€
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'SAT20_STATUS_UPDATE',
                            status: 'connected',
                            methods: methods
                        }, '*');
                    }
                } catch (e) {
                    // å¿½ç•¥è·¨åŸŸé”™è¯¯
                }
            } else {
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 mr-2';
                statusText.textContent = 'SAT20 Provider æœªæ‰¾åˆ°';
                providerInfo.innerHTML = 'è¯·ç¡®ä¿åœ¨ SAT20 é’±åŒ…çš„ DApp æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢';
                methodsList.innerHTML = '';

                log('âŒ SAT20 Provider æœªæ£€æµ‹åˆ°');

                // é€šçŸ¥çˆ¶çª—å£ provider çŠ¶æ€
                try {
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'SAT20_STATUS_UPDATE',
                            status: 'disconnected'
                        }, '*');
                    }
                } catch (e) {
                    // å¿½ç•¥è·¨åŸŸé”™è¯¯
                }
            }
        }

        function log(message) {
            const results = document.getElementById('test-results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            results.scrollTop = results.scrollHeight;
        }

        async function testGetAccounts() {
            try {
                log('ğŸ” è°ƒç”¨ getAccounts()...');
                const accounts = await window.sat20.getAccounts();
                log('âœ… getAccounts æˆåŠŸ: ' + JSON.stringify(accounts));
            } catch (error) {
                log('âŒ getAccounts å¤±è´¥: ' + error.message);
            }
        }

        async function testGetNetwork() {
            try {
                log('ğŸ” è°ƒç”¨ getNetwork()...');
                const network = await window.sat20.getNetwork();
                log('âœ… getNetwork æˆåŠŸ: ' + JSON.stringify(network));
            } catch (error) {
                log('âŒ getNetwork å¤±è´¥: ' + error.message);
            }
        }

        async function testGetBalance() {
            try {
                log('ğŸ” è°ƒç”¨ getBalance()...');
                const balance = await window.sat20.getBalance();
                log('âœ… getBalance æˆåŠŸ: ' + JSON.stringify(balance));
            } catch (error) {
                log('âŒ getBalance å¤±è´¥: ' + error.message);
            }
        }

        async function testRequestAccounts() {
            try {
                log('ğŸ” è°ƒç”¨ requestAccounts()...');
                const accounts = await window.sat20.requestAccounts();
                log('âœ… requestAccounts æˆåŠŸ: ' + JSON.stringify(accounts));
            } catch (error) {
                log('âŒ requestAccounts å¤±è´¥: ' + error.message);
            }
        }

        async function testSignMessage() {
            try {
                log('ğŸ” è°ƒç”¨ signMessage()...');
                const message = 'Hello SAT20 Wallet!';
                const signature = await window.sat20.signMessage(message);
                log('âœ… signMessage æˆåŠŸ: ' + JSON.stringify(signature));
            } catch (error) {
                log('âŒ signMessage å¤±è´¥: ' + error.message);
            }
        }

        // ç›‘å¬æ¥è‡ªçˆ¶çª—å£çš„æ¶ˆæ¯
        window.addEventListener('message', function(event) {
            // å¤„ç†æ£€æŸ¥è¯·æ±‚
            if (event.data.type === 'SAT20_CHECK_REQUEST' && event.data.source === 'parent') {
                window.parent.postMessage({
                    type: 'SAT20_CHECK_RESPONSE',
                    messageId: event.data.messageId,
                    hasSat20: !!window.sat20,
                    methods: window.sat20 ? Object.keys(window.sat20) : []
                }, '*');
                return;
            }

            // å¤„ç†æµ‹è¯•è¯·æ±‚
            if (event.data.type === 'SAT20_TEST_REQUEST' && event.data.source === 'parent') {
                const satProperties = Object.getOwnPropertyNames(window).filter(name => name.toLowerCase().includes('sat'));
                window.parent.postMessage({
                    type: 'SAT20_TEST_RESPONSE',
                    messageId: event.data.messageId,
                    hasSat20: !!window.sat20,
                    methods: window.sat20 ? Object.keys(window.sat20) : [],
                    hasGetAccounts: window.sat20 && typeof window.sat20.getAccounts === 'function',
                    satProperties: satProperties
                }, '*');
                return;
            }
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ provider
        document.addEventListener('DOMContentLoaded', function() {
            checkProvider();

            // æ¯éš”å‡ ç§’é‡æ–°æ£€æŸ¥ï¼Œä»¥é˜² provider ç¨åæ³¨å…¥
            setInterval(checkProvider, 3000);
        });
    </script>
</body>
</html>